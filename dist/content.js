(()=>{"use strict";let e=!1,t=[],n=null,o=0,i=null,r=null,l=null;function c(){console.log("highlightSelection called");const e=window.getSelection();if(!e||!e.rangeCount)return void console.log("No selection range");const n=e.getRangeAt(0);if(n.collapsed)return void console.log("Range is collapsed, not highlighting");console.log("Selection range:",n);const o=function(){const e=d[s];return s=(s+1)%d.length,e}(),i=function(e,t){console.log("createHighlightElements called with range:",e);const n=[];let o=0;const i=document.createNodeIterator(e.commonAncestorContainer,NodeFilter.SHOW_TEXT);let r;for(;null!==(r=i.nextNode());){if(o++,console.log("count",o),o>500)return n;if(!e.intersectsNode(r))continue;const i=r===e.startContainer?e.startOffset:0,l=r===e.endContainer?e.endOffset:r.textContent.length;if(i!==l){const e=document.createElement("mark");e.className="web-highlighter-highlight",e.style.backgroundColor=t,e.style.color="inherit";const o=r.textContent.substring(i,l);e.textContent=o;const c=r.textContent;if(r.textContent=c.substring(0,i),r.parentNode.insertBefore(e,r.nextSibling),l<c.length){const t=document.createTextNode(c.substring(l));r.parentNode.insertBefore(t,e.nextSibling)}n.push(e)}if(r===e.endContainer)break}return console.log("Created highlight elements:",n),n}(n,o);i.length>0&&(t.push({elements:i,color:o}),console.log("Added highlights to highlightedRanges:",i)),e.removeAllRanges(),console.log("Selection cleared")}chrome.runtime.onMessage.addListener(((t,n,o)=>("toggleHighlight"===t.action?(e=!e,e?(function(){const e=document.createElement("style");e.textContent="\n    mark.web-highlighter-highlight {\n      background-color: inherit !important;\n      color: inherit;\n      padding: 0;\n      margin: 0;\n      display: inline;\n      font-size: inherit;\n      font-weight: inherit;\n      line-height: inherit;\n      text-decoration: inherit;\n    }\n  ",document.head.appendChild(e)}(),document.addEventListener("mouseup",c),function(){const e=[document.querySelector("article"),document.querySelector("main"),document.querySelector(".main-content"),document.querySelector("#content"),document.body];l=e.find((e=>null!==e))||null}(),document.addEventListener("keydown",u),i=document.createElement("div"),i.style.cssText="\n    position: absolute;\n    width: 8px;\n    height: 16px;\n    background-color: #00FF00;\n    opacity: 0.7;\n    z-index: 10000;\n    pointer-events: none;\n    transition: all 0.1s ease;\n  ",document.body.appendChild(i),r=setInterval((()=>{i.style.visibility="hidden"===i.style.visibility?"visible":"hidden"}),530)):(a(),document.removeEventListener("mouseup",c),document.removeEventListener("keydown",u),i&&(i.remove(),i=null),r&&(clearInterval(r),r=null)),o({status:"Highlighting "+(e?"enabled":"disabled")})):"clearHighlights"===t.action&&(a(),o({status:"Highlights cleared"})),!0)));let s=0;const d=["yellow","lightgreen","lightblue","pink","orange"];function a(){console.log("clearHighlights called"),t.forEach((e=>{e.elements.forEach((e=>{if(e&&e.parentNode){const t=e.parentNode,n=document.createTextNode(e.textContent||"");t.replaceChild(n,e),console.log("Removed highlight:",e)}}))})),t=[],console.log("All highlights cleared")}function u(e){if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)){switch(n||(n=document.body,o=0),e.key){case"h":h(-1);break;case"l":h(1);break;case"j":!function(){try{const e=p(n,o,"down");e&&m(e)}catch(e){console.error("Error in moveDown:",e)}}();break;case"k":!function(){try{const e=p(n,o,"up");e&&m(e)}catch(e){console.error("Error in moveUp:",e)}}();break;case"w":!function(){const e=function(e,t){let n=e,o=t;for(;n;){if(n.nodeType===Node.TEXT_NODE){const e=n.textContent.slice(o),t=e.match(/\S+\s+\S/);if(t)return{node:n,offset:o+t.index+t[0].length-1};if(e.match(/\S+$/)){const e=g(n);if(e)return{node:e,offset:0}}}const e=g(n);if(!e)break;n=e,o=0}return null}(n,o);e&&(n=e.node,o=e.offset)}();break;case"b":!function(){const e=function(e,t){let n=e,o=t;for(;n;){if(n.nodeType===Node.TEXT_NODE){const e=n.textContent.slice(0,o).match(/\S+\s*$/);if(e)return{node:n,offset:e.index}}const e=f(n);if(!e)break;n=e,o=n.textContent.length}return null}(n,o);e&&(n=e.node,o=e.offset)}();break;case"0":!function(){const e=document.createRange();e.setStart(n,o);const t=e.getBoundingClientRect(),i=document.caretRangeFromPoint(0,t.top+t.height/2);i&&(n=i.startContainer,o=i.startOffset)}();break;case"$":!function(){const e=document.createRange();e.setStart(n,o);const t=e.getBoundingClientRect(),i=document.caretRangeFromPoint(document.documentElement.clientWidth-1,t.top+t.height/2);i&&(n=i.endContainer,o=i.endOffset)}()}e.preventDefault()}}function g(e){let t=function(e){for(;e&&null===e.nextSibling;)e=e.parentNode;if(!e)return null;for(e=e.nextSibling;e;){if(e.nodeType===Node.TEXT_NODE)return e;if(e.firstChild)e=e.firstChild;else{for(;e&&null===e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return null}(e);return t}function f(e){let t=function(e){for(;e&&null===e.previousSibling;)e=e.parentNode;if(!e)return null;for(e=e.previousSibling;e;){if(e.nodeType===Node.TEXT_NODE)return e;if(e.lastChild)e=e.lastChild;else{for(;e&&null===e.previousSibling;)e=e.parentNode;e&&(e=e.previousSibling)}}return null}(e);return t}function h(e){if(n&&n.nodeType===Node.TEXT_NODE){if(o+=e,o<0){const e=f(n);e?(n=e,o=n.textContent.length-1):o=0}else if(o>n.textContent.length-1){const e=g(n);e?(n=e,o=0):o=n.textContent.length-1}}else{const t=b(n).filter(C);t.length>0&&(n=t[0],o=e>0?0:n.textContent.length-1)}}function p(e,t,n){if(!e||!e.parentElement)return console.error("Invalid node or parent element"),null;let o;try{const n=document.createRange();n.setStart(e,t),n.collapse(!0),o=n.getBoundingClientRect()}catch(t){console.error("Error getting bounding rect:",t),o=e.parentElement.getBoundingClientRect()}if(!o||void 0===o.top)return console.error("Unable to get valid bounding rectangle"),null;const i=o.left;let r="up"===n?o.top-1:o.bottom+1;const l=window.getComputedStyle(e.parentElement),c=parseInt(l.lineHeight)||parseInt(l.fontSize)||20,s=1.5*c;let d=null,a=1/0;for(let t=0;t<s;t++){const l="up"===n?r-t:r+t,s=document.caretRangeFromPoint(i,l);if(s&&s.startContainer!==e)try{const e=s.getBoundingClientRect(),t=Math.abs(e.top-o.top);t<a&&(d={offsetNode:s.startContainer,offset:s.startOffset},a=t)}catch(e){console.error("Error getting bounding rect for new position:",e);continue}if(d&&t>c)break}return d}function m(e){if(!e||!e.offsetNode)return void console.error("Invalid position");let t=e.offsetNode,i=e.offset;for(;t&&t.nodeType!==Node.TEXT_NODE;)t=E(t);t&&t.parentElement&&N(t.parentElement)?(n=t,o=i):console.error("Unable to find valid text node")}function b(e){const t=[];if(e.nodeType===Node.TEXT_NODE)t.push(e);else{const n=e.childNodes;for(let e=0;e<n.length;e++)t.push(...b(n[e]))}return t}function N(e){if(e.nodeType!==Node.ELEMENT_NODE)return!1;const t=e.tagName.toLowerCase();if(["script","style","nav","header","footer","aside","button","input","textarea","select"].includes(t))return!1;const n=window.getComputedStyle(e);if("none"===n.display||"hidden"===n.visibility)return!1;const o=e.className.toLowerCase();return!(o.includes("nav")||o.includes("menu")||o.includes("sidebar")||!function(e){if(e.nodeType!==Node.ELEMENT_NODE)return!1;const t=e.textContent||"",n=e.innerHTML;return t.length/n.length>.5}(e))}function E(e){var t,n;let o=e;for(;o;){if(o.firstChild&&N(o))o=o.firstChild;else if(o.nextSibling)o=o.nextSibling;else{for(;o.parentNode&&!o.parentNode.nextSibling;)o=o.parentNode;if(!o.parentNode)return null;o=o.parentNode.nextSibling}if(o&&o.nodeType===Node.TEXT_NODE&&""!==(null===(t=o.textContent)||void 0===t?void 0:t.trim()))return o;if(o&&o.nodeType===Node.ELEMENT_NODE&&N(o)&&""!==(null===(n=o.textContent)||void 0===n?void 0:n.trim()))return o.firstChild}return null}function C(e){return!0}})();